<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>视频上传</title>
</head>
<body>
<form action="" id="videoup">
    <input type="file" id="video" accept="video/*">
    <button type="submit">上传</button>
</form>
<script>
    let canClick = true; // 是否可以点击上传
    let ot; // 时间
    let oladed; // 上传文件大小
    // 获取视频大小与名称
    function getNameSize(id) {
        let oVideo = document.querySelector(id);
        oVideo.addEventListener('change', function () {
            let file = this.files[0];

            // 上传文件格式判定
            if (!/video\/\w+/.test(file.type)) {
                alert("您应该上传视频类型文件！");
                return false;
            }

            let size = (file.size / 1024 / 1024).toFixed(2) + 'M';
            let name = file.name;
            console.log(name, size);
        }, false);
    }

    getNameSize('#video');

    // 点击上传
    function upVideo(id) {
        let oSubmit = document.querySelector(id);
        oSubmit.onclick = function (e) {
            e.preventDefault();
            let formVideo = document.getElementById('videoup');
            let formData = new FormData(formVideo);
            console.log(form);
           ajax(formData)
        }
    }

    // ajax 上传请求
    function ajax(formData, url) {
        canClick = false;
        let xhr = new XMLHttpRequest();
        xhr.open('post', url);
        xhr.onload = uploadComplete; // 请求完成
        xhr.onerror = uploadFailed; // 请求失败
        xhr.onload.onprogress = progressFunction; // 上传进度方法
        xhr.upload.onloadstart = uploadStart;
        xhr.send(formData); // 开始上传，发送数据
        // 请求完成方法
        function uploadComplete(evt) {
            //服务断接收完文件返回的结果  注意返回的字符串要去掉双引号
            canClick = true;
            if(evt.target.responseText){
                alert('上传成功:' + evt.target.responseText);
            }else{

            }
        }

        // 请求失败方法
        function uploadFailed(evt) {
            console.log('上传失败: '+ evt);
        }

        // 监听上传进度
        function progressFunction(ev) {
            console.log(ev);
            if(ev.lengthComputable){
                //TODO:  上传进度条开始显示
                let percent = (ev.loaded / ev.total) * 100 + '%';
                console.log(percent);
            }
        }

        // 开始上传
        function uploadStart() {
            console.log('开始上传');
            // 初始化上传时间与已上传文件大小
            ot = new Date().getTime();
            oloaded = 0;
        }

    }
</script>
</body>
</html>